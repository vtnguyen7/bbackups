#!/bin/bash

#############
# Variables #
#############

# Load globals and overwrite
. /etc/backup/backup.conf

# exit if there's an error
set -e

#################################
#  create the weekly snapshot   #
#################################

# Save the time
DATE=$(date +%F_%H00)

# prune the daily snapshots
while [[ $(find $WEEKLY_DIR -maxdepth 1 -iname "weekly_*" -type d | wc -l) -gt $WEEKLY ]]
do
	rm -fr $(find $WEEKLY_DIR -maxdepth 1 -iname "weekly_*" -type d | sort | head -n 1)
done

# if there are no snapshots in the weekly directory which are less than 6 days old, make a new snapshot
if [[ -z $(find $WEEKLY_DIR -maxdepth 1 -iname "weekly_*" -type d -mtime -6) ]] ; then

	# create an archived and hardlinked copy
	cp -al $MIRROR_DIR $WEEKLY_DIR/weekly_$DATE
	
	# touch the directory to update the mtime
	touch $WEEKLY_DIR/weekly_$DATE
	
	# log the completion
	logger -p daemon.info "created a weekly snapshot at $(date)"
else
        logger -p daemon.info "not yet time to create a weekly snapshot"
fi
